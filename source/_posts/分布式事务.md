---
title: 分布式事务
date: 2018-11-21 18:38:44
tags: [tech]
categories: 实践技术
---

# 定义

> A **distributed transaction** is a [database transaction](https://en.wikipedia.org/wiki/Database_transaction) in which two or more network hosts are involved. Usually, hosts provide **transactional resources**, while the **transaction manager** is responsible for creating and managing a global transaction that encompasses all operations against such resources. 

<center>摘自维基百科</center>
简单来讲，目的就是使基于不同节点数据库之间协作的事务，能够达到原子性、一致性、隔离性要求。

<!-- more -->

# 详解

主要要介绍的一些概念：XA协议、两阶段提交（2PC）、三阶段提交（3PC）、TCC（try、confirm、cancel）以及介绍一下MySQL对XA的支持。

### XA协议

XA指X/Open 国际联盟提出的 X/Open Distributed Transaction Processing（DTP）模型，主要描述了事务管理器（TM，Transaction Manager）和多个资源管理器（RM，Resource Manager）之间的接口。

### 两阶段提交

XA使用两阶段提交来保证分布式事务的原子性。两个阶段分别为准备阶段与提交阶段。准备阶段确保所有RM本地事务成功，否则通知RM回滚。

优点：提供很好的一致性保证。

缺点：阻塞；单点故障（TM出问题很严重）；异常处理差（某些节点故障情况）。
基于两阶段提交的系统不能提供很高的并发性。

### 三阶段提交

引入了超时机制，并且将二阶段提交的准备阶段再细分成了两个阶段。还没见过具体的应用，现在先不展开细节讲了。

### TCC

整体也采用了两阶段提交的思想，但是仅仅用于保证了分布式事务的原子性（传统方法隔离性通过锁定数据库资源来完成，并发性能低，不适合互联网高并发场景），事务的隔离性交由应用层面方法来实现，通过业务层面加锁即可（confirm、cancel需要满足幂等性）。高并发通常只能满足最终一致性。

### MySQL XA

结合MySQL中对XA的支持可以更好地理解TCC的原理。MySQL有内部XA与外部XA，外部XA对应的就是多数据库场景，内部XA指的是单数据库内基于多个存储引擎的事务。性能需求不高的话可以尝试使用。

### 其他分布式事务方案

基于消息中间件的解决方案
