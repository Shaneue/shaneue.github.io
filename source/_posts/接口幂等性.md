---
title: 接口幂等性
date: 2018-11-19 17:42:22
tags: [tech]
categories: 实践技术
---

# 简介

**幂等性定义** 在使用者多次调用接口时，每次得到的结果是一致的。假设一个接口的业务已经执行，但是系统错误，调用者没有收到返回结果，这时，调用者可能发起重试，于是再次调用了该接口，如果该接口不满足幂等性，就造成了错误的结果了。这种情形在微服务架构中较为常见。

<!-- more -->

有些接口天然支持幂等性，比如查询接口，多次重试不会影响系统的正确性。但是，对于增加、删除、更新类的操作，需要额外的开发才能保证接口的幂等性。

# 常见方案

### 全局唯一ID

根据业务的内容设计一个全局ID，在操作执行前先判断这个全局ID是否已经存在。如果不存在，则在操作成功执行后将这个ID存储起来，否则表示该操作已执行，避免重复执行。如果考虑了微服务宕机的情形，还可以给ID添加一个超时字段。

具体实践来说，可以启用一个微服务专门来处理幂等性问题，这样在架构上，其他模块只需要依赖所提供的接口来实现幂等性，而提供幂等性的服务可以专注于提升自己的可用性上。

### 基于数据库去重

利用数据库事务的ACID特性，将一些只有数据库操作的业务，以及该业务的唯一ID写入一张去重表这两个操作做成事务，如果写入去重表失败，事务就会回退。

### 数据库插入或更新

如果是插入操作，插入失败时转为更新，这种简单的策略也能保证一些简单操作的幂等性。

### 多版本控制

如果是更新操作，可以考虑加一个版本字段，根据版本号的大小关系来决定是否已更新。

### 添加状态

在实体对象有状态转移的情形下使用，可以通过判断实体的状态阶段来判断是否需要继续进行更新操作。