---
title: Jenkins
date: 2019-03-11 11:30:45
tags: [tech]
categories: 运维
---

# 简介

Jenkins工具可以在构建、发布、部署、测试等流程上做自动化，团队熟练使用之后，可成倍提高迭代速度。

<!-- more -->

## RPM构建

#### 背景

项目有为大量客户单独部署的需求，系统的部署流程杂，依赖多，并且服务器可能处于无法联网状态。但是通常我们要求客户提高的系统都默认采用RPM包管理器。因此，可采用RPM包制作的自动化来统一流程与管理版本。

#### 具体步骤

1. 将RPM相关的SOURCES以及SPECS两个文件夹的内容更新于Git。
2. 系统的多模块代码分别经CI自动更新于软件仓库或者文件服务器。
3. 构建一个Jenkins工程，工程拉取RPM的Git工程。
4. 在Jenkins脚本中生成RPM-build目录，将SOURCES与SPECS资源拷贝到RPM构建目录中。
5. 将系统多模块二进制代码下载到相应的位置。
6. 启动RPM构建过程。
7. 将产出RPM包上传至文件服务器，或者Jenkins的workspace目录以供下载。

## 镜像自动构建与推送

#### 背景

转型微服务架构中，项目繁多，并且需要经常发布验证，可在CI流程的最后添加打包推送过程，从而方便在集群实时滚动升级。

#### 相关事项

- 容器化部署的Jenkins可选择挂载宿主机的二进制docker文件（/usr/bin/docker)以及套接字（/var/run/docker.sock)与daemon通信。
- Git工程根目录维护Dockerfile文件。
- 直接利用mvn编译后的二进制文件或jar包，构建镜像并推送，只需要简单几句shell命令即可达成。
- Docker重复构建之后会留有none类型的镜像，目前是另起一个定时Jenkins job来清除（不知道还有没有更优雅的方式）。
- 并推荐使用全局变量，比如分支名，镜像的tag名等，达到控制多个分支的目的。

## 功能测试

#### 背景

团队需要实践TDD开发，如果有一套较完善的接口测试代码，可考虑通过Jenkins触发并生成报表。比如基于Python的pytest、allure、urllib3等模块的轻量级测试框架。

#### 相关事项

- 服务器地址可以配置
- Git维护测试源码
- 测试代码也要好好构思，容易维护为佳
- 验证码识别，可通过Tesseract等图像识别技术。成功率比较低，可考虑自建模型（如果有验证码尝试次数的系统似乎不方便使用）。

## 持续集成

最基础的功能，主要需要考虑编译、代码静态检查、公共依赖包推送等。失败情况下，及时通知相关人员处理。同时插件支持关联相关平台，比如SonarQube、报表地址等。