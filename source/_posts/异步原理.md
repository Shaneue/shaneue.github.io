---
title: 异步原理
date: 2018-11-16 21:47:21
tags: [cs]
categories: 计算机
typora-root-url: ../
---

# Unix I/O模型

![](/images/io_model.png)

<!-- more -->

- **阻塞I/O**

  相关函数：recvfrom

  socket（套接字，socket其实也是文件）以及 fd（file description，文件描述符）默认情况下是阻塞的，会使请求阻塞，直到完成或者出错。

- **非阻塞I/O**

  该类型I/O发起时，如果内核缓冲区没有数据会立即返回一个错误，并且轮询（polling）直到内核缓冲区数据准备完成。在数据复制到用户缓冲区阶段进程也是阻塞的。

- **I/O多路复用**

  相关函数：select、poll、epoll、pselect、ppoll

  这些函数在调用时也是阻塞住调用线程的，与阻塞I/O相比，主要优势是可以同时监听多个socket或fd。

  待内核数据准备好，应用便可调用recvfrom函数。

  epoll与select、poll的主要区别：
  1. epoll提供了epoll_create、epoll_ctl、epoll_wait三个函数，seletc与poll只提供对应的一个函数；
  2. epoll基于事件驱动，会为每一个fd添加回调函数，只要fd就绪，会自动将fd放入一个结构中，然后调用epoll_wait来获取就绪的fd列表；而select、poll需要不断轮询fd列表；
  3. select、poll每次调用需要将fd列表从用户空间往内核空间拷贝，而epoll不需要对fd轮询，因此总体来说只需要拷贝一次即可，此外，epoll还使用了内存映射（mmap）；
  4. select有fd上限，而poll、epoll用链表存储，没有这个限制。
  5. epoll的构建开销比较大，在高并发的场景下，有很好的性能。但是如果并发量少，并且连接活跃，epoll不见的有最好的性能；
  6. epoll是Linux独有，select、poll具有POSIX标准。

  该方案是Unix类系统使用最广的，具体原理与使用方法需要查询权威资料或源码。

- **信号驱动I/O**

  该类型I/O对于TCP socket几乎没有什么实际作用，通常配合UDP使用。使用场景比如NTP（Network Time Protocal）服务器。与异步I/O相比，在数据从内核到用户这个阶段并不是异步的。

- **异步I/O**

  Unix类系统暂时并没有特别成熟的实现。Windows有IOCP（Input/Output Completion Port）。
