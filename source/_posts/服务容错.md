---
title: 服务容错
date: 2019-07-10 15:11:56
tags: [tech]
categories: 实践技术
---

# 背景

在SOA架构中，各个提供服务的模块相对独立，并且存在调用链。如果上游服务承受不住当前的请求量，资源耗尽或者响应过慢，甚至服务没在运行，最终会导致所有下游服务都呈现出拒绝服务的状态。但是其实某些情况下，不是那么重要的上游服务即使已经无法及时处理请求，也不应该让下游服务雪崩。还有一种情况，某个模块提供多类服务，因为资源共享等，当其中一类服务占用了所有的计算资源，导致其他所有的服务无资源可用。这时，就需要引入服务容错机制，比如说比较流行的Hystrix。

<!-- more -->

# 容错机制

## 线程隔离

主要有两种方式，线程池隔离与信号量。

#### 线程池隔离

原理就是让不同类别的服务独立使用不用的线程池，让框架去保证线程池的异常不会扩大。

#### 信号量

信号量适用于非网络请求的情形。比如一段代码处理逻辑需要耗费明显的资源且需要被多个线程共享，为了避免过多线程调用这段代码，给它加上信号量，控制调用的并发量，当线程数超过阈值时可立即返回预设的默认值，避免占用资源。

### 熔断降级

熔断降级实现在上游服务的客户端上，即下游服务。降级指的是服务不可用，或者请求超时时，会选择一个默认的Fallback降级实现来替代原本的上游服务处理逻辑。

熔断指当上游服务错误状态持续一段时间（包括请求错误次数、响应时间过长等等）后，直接将熔断器（Circuit Breaker）打开，不再尝试去请求上游服务。

另外，框架本身还提供熔断器关闭的功能。比如，过一段时间后，会尝试一下上游服务接口，看看是否已经可用。

### Feign

该服务调用组件已支持Hystrix的熔断降级功能。